name: Compile and Test
on:
  pull_request:
    branches:
      - master
jobs:
  DockerComposeTest:
    strategy:
      fail-fast: false
      matrix:
        command:
          - go
          - aws
          - python
          - rustc
          - zip
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: "Test: docker-compose ${{matrix.command}}"
        run: |
          DOCKERIZED_ROOT=$GITHUB_WORKSPACE docker compose run --rm --entrypoint=uname ${{matrix.command}} 2>&1 | tee ~/compose.log
          grep -q '^Linux' ~/compose.log
  ShellTest:
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        command:
          - go
          - aws
          - python
          - rustc
          - zip
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Dockerized
        uses: actions/checkout@v2
      - name: Compile
        run:  bin/dockerized --compile
      - name: "Test: dockerized --shell ${{matrix.command}}"
        env:
          COMMAND: "${{matrix.command}}"
        run: |
          bin/dockerized -v --shell $COMMAND -c env 2>&1 | tee ~/shell.log
          grep HOST_HOSTNAME=$(hostname) ~/shell.log
  IntegrationTest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v2
        with:
          go-version: '1.17.8'
      - name: Checkout Dockerized
        uses: actions/checkout@v2
      - name: go test
        run: |
          DOCKERIZED_ROOT=$(pwd) go test -p 1 .
  CompileAndTest:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-20.04
#          - windows-2022
#          - macos-10.15
      max-parallel: 1
      fail-fast: true
    steps:
      # region mac
      - name: Install Docker
        if:  runner.os == 'macOS'
        uses: docker-practice/actions-setup-docker@master
      # endregion

      - name: Checkout Dockerized
        uses: actions/checkout@v2
        with:
          path: dockerized

      - run: dockerized/bin/dockerized --help
        shell: bash

      - run: dockerized/bin/dockerized go version
        shell: bash

      - name: "Test: version from environment variable"
        run: GO_VERSION=1.16.15 dockerized/bin/dockerized go version | grep "go1.16.15"
        shell: bash

      - name: "Test: version from dockerized.env"
        run: |
          mkdir -p project
          cd project
          echo 'GO_VERSION=1.17.8' > dockerized.env
          ../dockerized/bin/dockerized go version | grep "1.17.8"
        shell: bash

      - name: "Test: command that requires building (protoc)"
        run: dockerized/bin/dockerized protoc --version
        shell: bash

      - name: "Test: dockerized returns inner exit code"
        run: |
          # Run a command that returns 100, check that dockerized returns 100
          EXITCODE=$(dockerized/bin/dockerized bash -c 'exit 100' &>/dev/null || echo $?)
          echo "Exit code: $EXITCODE"
          [ $EXITCODE -eq 100 ]
        shell: bash

      # region windows
      - if: runner.os == 'windows'
        name: "dockerized --compile (cmd)"
        shell: cmd
        run: bin/dockerized --compile
      - if: runner.os == 'windows'
        name: "dockerized --compile (powershell)"
        shell: cmd
        run: bin/dockerized --compile
      # endregion
